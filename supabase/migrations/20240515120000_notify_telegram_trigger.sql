-- Миграция: Edge HTTP Trigger для Telegram-уведомлений о новых бронированиях\n-- Включает расширение http и создаёт функцию + триггер\n\n-- 1) Убедимся, что расширение http доступно\ncreate extension if not exists http with schema extensions;\n\n-- 2) Функция, вызывающая Edge Function notify_telegram\ncreate or replace function public.notify_telegram_edge()\nreturns trigger\nlanguage plpgsql\nas $$\nbegin\n  -- Отправка POST-запроса к Edge Function\n  perform\n    extensions.http_post(\n      'http://localhost:54321/functions/v1/notify_telegram',\n      'application/json',\n      to_jsonb(row_to_json(NEW))::text,\n      array[ \"Content-Type: application/json\" ]\n    );\n\n  return NEW;\nend;\n$$;\n\n-- 3) Триггер после вставки новой брони\ncreate trigger notify_telegram_trigger\nafter insert on public.table_bookings\nfor each row execute procedure public.notify_telegram_edge();